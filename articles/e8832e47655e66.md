---
title: "Ktorã‚’ç´¹ä»‹ã™ã‚‹ã¨ã¨ã‚‚ã«ã€2024/4ç¾åœ¨ã®æ³¨æ„ç‚¹ã‚‚ç´¹ä»‹"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ktor", "Kotlin", "webframework"]
published: true
---

# å‰æã¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
io.ktor:ktor-server-core-jvm:2.3.9
io.ktor:ktor-server-netty-jvm:2.3.9
IntelliJ IDEA 2024.1

# Ktorã®ç‰¹å¾´

- ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãªã©ã‚’ã€@Resourceã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§å®Ÿè£…ã§ãã‚‹
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨çµ„ã¿åˆã‚ã›ã‚„ã™ãã€ãƒã‚¹ãƒˆãŒæ·±ã„ç‰¹å®šã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã ã‘ã«èªè¨¼æ©Ÿèƒ½ãªã©ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹ã¨ã„ã£ãŸã“ã¨ãŒè‡ªç„¶ã«ã§ãã‚‹
- **swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”ŸæˆãŒã§ãã‚‹** å‰²ã¨ç›®ç‰æ©Ÿèƒ½
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä½¿ã„ã‚„ã™ã„HOCON(Human-Optimized Config Object Notation)ã‚’ä½¿ã£ãŸè¨­å®šãŒã§ãã‚‹

# ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆ@Resourceï¼‰ãªã©ã®å®Ÿè£…ä¾‹

å®Ÿè£…ä¾‹ã§ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ï¼ˆURLã®å®šç¾©ï¼‰ã™ã‚‹ç®‡æ‰€ã«ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ï¼ˆURLã®å®šç¾©ï¼‰ã ã‘ã‚’æ›¸ãã€‚
- ãƒªã‚½ãƒ¼ã‚¹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆSpring Frameworkã£ã½ã„ãƒãƒ¼ãƒŸãƒ³ã‚°ã§ã™ãŒï¼‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æ›¸ãã€‚
- åŸºæœ¬çš„ã«å…¨éƒ¨ã€å…¨éƒ¨ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãª@Resourceã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã£ã¦å®Ÿè£…ã™ã‚‹

```kotlin
// Routing.kt
// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹
fun Application.configureRouting() {
    install(Resources)
    routing {
        pingRoute()
        route("v1") {
            authenticatedRoute()
        }
    }
}
```

```kotlin
// AuthenticatedRoute.kt
// ãƒªã‚½ãƒ¼ã‚¹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¸¦ã¹ã‚‹
fun Route.authenticatedRoute() {
    companiesResourceHandler()
    hoge1ResourceHandler()
    hoge2ResourceHandler()
    hoge3ResourceHandler()
}
```

```kotlin
// CompaniesResource.kt
// URLã®å®šç¾©ã‚’æ›¸ãã¾ã™
class CompaniesResource {
    @Resource("companies")
    class Index(
        val q: String? = null,
    )

    @Resource("companies/{id}")
    class Id(
        val id: Int,
    )
}
```

```kotlin    
/**
CompaniesResourceHandler.kt
ã“ã“ã§ã¯~Resourceã«å¯¾ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æ›¸ãã¾ã™
ä»¥ä¸‹ã€routingã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ã‚ãªã„
io.ktor.server.routing.get
io.ktor.server.routing.post
io.ktor.server.routing.put
io.ktor.server.routing.delete

ä»¥ä¸‹ã€resourcesãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†
io.ktor.server.resources.get
io.ktor.server.resources.post
io.ktor.server.resources.put
io.ktor.server.resources.delete
 */
fun Route.companiesResourceHandler() {
    val companiesController by inject<companiesController>() // DI with ktor-koin 
    get<CompaniesResource.Index> { params ->
        val responseBody = companiesController.index(call.principal(), params)
        call.respond(status = HttpStatusCode.OK, message = responseBody)
    }
    post<CompaniesResource.Id> { params ->
        val createBody = call.receive<CompaniesCreateBody>()
        val responseBody = companiesController.create(call.principal(), createBody)
        call.respond(status = HttpStatusCode.OK, message = responseBody)
    }
}
```
```kotlin
// schema.kt
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ›¸ãã¾ã™
data class CompaniesCreateBody(
    val name: String,
)
```


# swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆã§ã®ä¸å…·åˆã‚„æ³¨æ„ç‚¹

## ç”Ÿæˆã•ã‚Œã‚‹swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®openapiã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ–°ã—ããªã£ãŸ
IntelliJ IDEA2024.1ã§swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®ï¼‘è¡Œç›®ã®openapiã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç®‡æ‰€ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚

```diff
- openapi: "3.0.3"
+ openapi: "3.1.0"
```

ã—ã‹ã—ã€3.1.0ã¯ã€OpenAPIGeneratorãŒã¾ã ä¸å…·åˆã‚’èµ·ã“ã™ï¼ˆarrayã§ä¸”ã¤åŒã˜å‹ãŒé€£ç¶šã—ã¦å®šç¾©ã•ã‚Œã‚‹ã¨æ­£ã—ã„å‹ã«ãªã‚‰ãªã„ï¼‰ãŸã‚ã€è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå¾Œã€æ‰‹ã§`openapi: "3.0.3"`ã¸æˆ»ã™ç­‰ã®å¯¾å¿œã‚’ä»Šã¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

https://twitter.com/momosetkn/status/1777653138004017505

## Nullableã«ã—ã¦ã„ãªã„ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ãŒrequiredã«ãªã‚‰ãªã„

2024/1é ƒã«ã€IntelliJ IDEA2024.1ã§ä¿®æ­£ã•ã‚Œã‚‹äºˆå®šã¨ã®ã“ã¨ã§ã—ãŸãŒã€ã¾ã ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

issueå ±å‘Š https://youtrack.jetbrains.com/issue/IDEA-324930/OpenAPI-generator-should-add-required-properties-for-non-nullable-fields?s=OpenAPI-generator-should-add-required-properties-for-non-nullable-fields


## enumã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¯ã«enumã®å®šç¾©ã‚’ç”Ÿæˆã—ã¦ã—ã¾ã„ã€é‡è¤‡ã™ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ã«data classã‚’å®šç¾©ã—ãŸå ´åˆã€

```kotlin
data class ExampleClass(
    val enum1: ExampleEnum,
    val enum2: ExampleEnum,
    val enum3: ExampleEnum,
)

enum class ExampleEnum {
    A, B, C
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«é‡è¤‡ã—ã¦ç”Ÿæˆã•ã‚Œã¾ã™

```yaml
    ExampleClass:
      type: "object"
      properties:
        enum1:
          type: "string"
          enum:
          - "A"
          - "B"
          - "C"
        enum2:
          type: "string"
          enum:
          - "A"
          - "B"
          - "C"
        enum3:
          type: "string"
          enum:
          - "A"
          - "B"
          - "C"
      required:
      - "enum1"
      - "enum2"
      - "enum3"
```

issueå ±å‘Š https://youtrack.jetbrains.com/issue/IDEA-344875/OpenAPI-generator-enum-definitions-are-duplicated

## isã¯ã˜ã¾ã‚Šã®Booleanã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

ä»£ã‚ã‚Šã«ã€flgã¨ã„ã†åå‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ã†ã¨ã€æ­£ã—ãç”Ÿæˆã•ã‚Œã¾ã™ã€‚

issueå ±å‘Š https://youtrack.jetbrains.com/issue/IDEA-332548/Boolean-fields-with-is-prefix-in-names-are-skipped-during-OpenApi-scheme-generation-with-Ktor-IDEA-plugin

# auto-reloadã®ä¸å…·åˆ

[Ktorã®auto\-reloadæ™‚ã«pluginã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ã¨å¿œç­”ã—ãªããªã‚Šã€åŸå› ç©¶æ˜ãŒã§ããªã„å•é¡Œã®ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰](https://zenn.dev/momosetkn/articles/fd5fecda04c708)
