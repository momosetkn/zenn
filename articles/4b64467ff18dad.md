---
title: "Kotlinã§Liquibaseã‚’ä½¿ã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã£ãŸ"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["liquibase", "kotlin", "komapper", "jooq", "exposed"]
published: true
---

:::message alert
âš å½“è¨˜äº‹ã¯ã€éŠ€ã®å¼¾ä¸¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å„è‡ªã®ç›®çš„ã‚„çŠ¶æ³ãªã©ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦ã€è‡ªåˆ†ã§è²¬ä»»ã‚’æŒã£ã¦æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
:::

:::message alert
âš å½“è¨˜äº‹ã¯ã€éŠ€ã®å¼¾ä¸¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å„è‡ªã®ç›®çš„ã‚„çŠ¶æ³ãªã©ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦ã€è‡ªåˆ†ã§è²¬ä»»ã‚’æŒã£ã¦æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
:::

â€»å¤§äº‹ãªã“ã¨ãªã®ã§ï¼’å›æ›¸ãã¾ã—ãŸ

# èª²é¡Œ

- Kotlinã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã€Liquibaseã«ã‚ˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚‚Kotlinã®æ–‡æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€Kotlinã§ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨åŒã˜ãƒãƒªã§æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚ã€Kotlinã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã¨ã£ã¦ã¯ã‚ã‚ŠãŒãŸã„ãŒã€ãã†ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã¾ã‚Šç„¡ã„ã€‚
- ä»Šã¾ã§ã‚ã£ãŸLiquibaseã®Kotlin-DSLã¯ã€kotlin-scriptã§ã®å®Ÿè¡Œã§ã‚ã£ãŸã€‚ãã®ãŸã‚ã€IDEã§ã§ã®è£œå®ŒãŒåŠ¹ã‹ãªã„ã“ã¨ãŒã‚ã£ãŸã€‚
- ä»Šã¾ã§ã®Liquibaseã®Kotlin-DSLãŒãƒ¡ãƒ³ãƒ†ã•ã‚Œã¦ã„ãªã„ã€‚
- LiquibaseãŒã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ã§ã®ä½¿ç”¨ã‚’æƒ³å®šã•ã‚Œã¦ã„ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ–ãƒ«ã«å®Ÿè¡Œã‚’ã™ã‚‹æ–¹æ³•ãŒåˆ†ã‹ã‚‰ãªã„
- ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã€DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§ã€ORMã‚’ä½¿ã„ãŸã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹

## ï¼ˆã¡ãªã¿ã«ï¼‰å„DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦é›‘ã«ã¾ã¨ã‚

[Flyway](https://github.com/flyway/flyway): SQLã§æ›¸ãã‚‚ã®ã€‚
[Liquibase](https://github.com/liquibase/liquibase): XMLã§ç®¡ç†ã€‚JSON. YAML, SQLã€Groovyã§ã‚‚æ›¸ã‘ã‚‹ãŒã€JSONã‚„YAMLã ã¨å­è¦ç´ ã¨ã„ã†æ¦‚å¿µãŒç„¡ããƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿ã§èª­ã¿ã«ãã„ã®ã§ã€XMLã‹Groovy-DSLã€ã¾ãŸã¯ä»Šå›ä½œã£ãŸKotlin-DSLãŒè‰¯ã•ãã†ã€‚
[Harmonica](https://github.com/KenjiOhtsuka/harmonica): Railsãƒ©ã‚¤ã‚¯ã€‚ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ãªã•ãã†ã€‚
[Exposed-migration](https://jetbrains.github.io/Exposed/table-definition.html): å±¥æ­´ç®¡ç†ã®ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç„¡ã„ã‚‰ã—ãã€å„è‡ªã§å·¥å¤«ãŒå¿…è¦

# è§£æ±ºç­–ï¼ˆä½œã£ãŸã‚‚ã®ï¼‰

https://github.com/momosetkn/liquibase-kotlin
ã“ã¡ã‚‰ã§ã™ã€‚

https://momosetkn.github.io/liquibase-kotlin-docs/home.html
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã“ã¡ã‚‰

æ©Ÿèƒ½ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Liquibaseã‚’å®Ÿè¡Œã§ãã‚‹Kotlinã®ãƒ©ãƒƒãƒ‘ãƒ¼
- kotlin-scriptã¨é€šå¸¸ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹Kotlinã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã€Kotlin-DSLã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- Liquibaseã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§ã€ORMã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

CIã«ã‚‚å·¥å¤«ã¨ã„ã†ã‹åŠªåŠ›ã‚’ã—ã¦ãŠã‚Šã€æ¯æ—¥SNAPSHOTç‰ˆã®Liquibaseã§ã®ãƒ†ã‚¹ãƒˆã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚éå…¬å¼ã®Liquibaseã®DSLã¯ã€æœ€æ–°ã®Liquibaseã«è¿½ã„ã¤ã„ã¦ã„ãªã„ã¨ã„ã†èª²é¡ŒãŒã ã„ãŸã„ã‚ã‚‹ãŸã‚ã€ã“ã“ã¯é‡è¦ãªã¨ã“ã‚ã ã¨æ€ã„ã¾ã™ã€‚
ã¾ãŸã€ç§ã®ä½œæˆã—ãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã«Liquibaseã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€å¯¾å¿œã—ã¦ã„ã‚‹Liquibaseã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

build.gradle.ktsã«ä»¥ä¸‹è¿½åŠ ã—ã¾ã™

```kotlin
dependencies {
    implementation("org.liquibase:liquibase-core:4.29.2")
    implementation("io.github.momosetkn:liquibase-kotlin-starter-compiled:4.29.2-0.8.0")
}
```

kotlin-scriptã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã¨ãªã‚Šã¾ã™

```kotlin
dependencies {
    implementation("org.liquibase:liquibase-core:4.29.2")
    implementation("io.github.momosetkn:liquibase-kotlin-starter-script:4.29.2-0.8.0")
}
```

ã“ã‚Œã‹ã‚‰ç´¹ä»‹ã™ã‚‹LiquibaseClientã‚’ä½¿ã†ã®ã§ã‚ã‚Œã°ã€åŸºæœ¬çš„ã«ã¯ã€`liquibase-kotlin-starter-compiled`ã§è‰¯ã„ã‹ãªã¨ã¯æ€ã„ã¾ã™ã€‚
ä»Šã¾ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã£ã¦ä½¿ã†ã‚ˆã†ã«ä½¿ã£ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ã€`liquibase-kotlin-starter-script`ã‚’ä½¿ã†ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

# ä½¿ã„æ–¹

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®å®Ÿè¡Œã‚’èª¬æ˜ã—ã¾ã™ã€‚
configureLiquibaseã§ã€Liquibaseã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªè¨­å®šã‚’æ›¸ãã¾ã™ã€‚
`LiquibaseDatabaseFactory.create`ã§ã€æ¥ç¶šå…ˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã€`LiquibaseClient`ã¸changeLogFileã‚’æ¸¡ã—ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¨ãªã‚Šã¾ã™ã€‚

```kotlin
import momosetkn.liquibase.client.LiquibaseDatabaseFactory
import momosetkn.liquibase.client.configureLiquibase
import momosetkn.liquibase.kotlin.parser.KotlinCompiledDatabaseChangeLog
import momosetkn.liquibase.client.LiquibaseClient

fun main() {
    // Liquibaseã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªè¨­å®š
    // å„è¨­å®šå€¤ã«ã¤ã„ã¦ã¯ä»¥ä¸‹å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ï¼
    // https://docs.liquibase.com/parameters/home.html
    configureLiquibase {
        global {
            general {
                showBanner = false
            }
        }
    }
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
    val database = LiquibaseDatabaseFactory.create(
        driver = "com.mysql.cj.jdbc.Driver",
        url = "jdbc:mysql://localhost:3306/test_db",
        username = "root",
        password = "",
    )
    // changeLogã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æŒ‡å®š
    val client = LiquibaseClient(
        changeLogFile = example.DatabaseChangelog20241007Employee1::class.qualifiedName!!,
        database = database,
    )
    // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼
    client.update()
}

class DatabaseChangelog20241007Employee1 : KotlinCompiledDatabaseChangeLog({
    changeSet(author = "your_name", id = "20241007-2000-1") {
        createTable(tableName = "employee") {
            column(name = "id", type = "UUID") {
                constraints(nullable = false, primaryKey = true)
            }
            column(name = "company_id", type = "UUID") {
                constraints(nullable = false)
            }
            column(name = "name", type = "VARCHAR(256)")
            column(name = "not_null_name", type = "VARCHAR(256)") {
                constraints(nullable = false)
            }
            column(name = "not_null_name2", type = "VARCHAR(256)") {
                constraints(nullable = false)
            }
        }
    }
})
```

## include/includeAll

includeã‚„includeAllã§ã¯ã€ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ãŒã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸKotlinï¼ˆæ‹¡å¼µå­ãŒktï¼‰ã§æ›¸ãå ´åˆã«ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãƒ»ã‚¯ãƒ©ã‚¹åãŒä½¿ãˆã¾ã™ã€‚
kotlin-scriptï¼ˆæ‹¡å¼µå­ãŒktsï¼‰ã‹ã‚‰ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸKotlinã®changeLogã‚’å‘¼ã³å‡ºã™å ´åˆã€ã‚¯ãƒ©ã‚¹ãƒ‘ã‚¹ä¸Šã§ã®åå‰ã®æŒ‡å®šã¨ãªã‚‹ãŸã‚ã€.ã‚’/ã¸ç½®ãæ›ãˆã¦ã€ã‚¯ãƒ©ã‚¹ã®æŒ‡å®šã®ãŸã‚ã«.classã‚’ã¤ã‘ã¾ã™

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸKotlinã®å ´åˆ

```kotlin
import momosetkn.liquibase.kotlin.parser.KotlinCompiledDatabaseChangeLog

class DatabaseChangelogAll : KotlinCompiledDatabaseChangeLog({
    // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸKotlinï¼ˆæ‹¡å¼µå­ãŒktï¼‰ã®å ´åˆã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãƒ»ã‚¯ãƒ©ã‚¹åã§æ›¸ã
    includeAll("example.migration")
    include("example.migration2.Example")
})

```

kotlin-scriptã®å ´åˆ

```kotlin
databaseChangeLog {
    // kotlin-scriptï¼ˆæ‹¡å¼µå­ãŒktsï¼‰ã®å ´åˆã€ã‚¯ãƒ©ã‚¹ãƒ‘ã‚¹ä¸Šã§ã®åå‰ã‚’æ›¸ã
    includeAll("example/migration")
    include("example/migration2/Example.class")
}
```

# ORMã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§ä½¿ã†

## Komapper(JDBC)

build.gradle.ktsã«ä»¥ä¸‹è¿½åŠ ã™ã‚‹

```kotlin
dependencies {
    implementation("io.github.momosetkn:liquibase-kotlin-custom-komapper-jdbc-change:4.29.2-0.8.0")
}
```

ãã†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§Komapperã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```kotlin
import momosetkn.liquibase.kotlin.parser.KotlinCompiledDatabaseChangeLog
import momosetkn.liquibase.kotlin.change.custom.komapper.customKomapperJdbcChange
import org.komapper.core.dsl.QueryDsl

class CompiledDatabaseChangelog1 : KotlinCompiledDatabaseChangeLog({
    changeSet(author = "your_name", id = "20241007-2000-1") {
        customKomapperJdbcChange(
            execute = { db ->
                val query = QueryDsl.executeScript(
                    """
                    CREATE TABLE created_by_komapper (
                        id uuid NOT NULL,
                        name character varying(256)
                    );
                    """.trimIndent()
                )
                db.runQuery(query)
            },
            rollback = { db ->
                val query = QueryDsl.executeScript("DROP TABLE created_by_komapper")
                db.runQuery(query)
            },
        )
    }
})
```

ã¾ãŸã€kotlin-scriptã®å ´åˆã§ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚QueryDslãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€QueryDslã‚’importç„¡ã—ã§ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```kotlin
databaseChangeLog {
    changeSet(author = "your_name", id = "20241007-2000-1") {
        customKomapperJdbcChange(
            execute = { db ->
                val query = QueryDsl.executeScript(
                    """
                    CREATE TABLE created_by_komapper (
                        id uuid NOT NULL,
                        name character varying(256)
                    );
                    """.trimIndent()
                )
                db.runQuery(query)
            },
            rollback = { db ->
                val query = QueryDsl.executeScript("DROP TABLE created_by_komapper")
                db.runQuery(query)
            },
        )
    }
}
```

## Exposed-migration

build.gradle.ktsã«ä»¥ä¸‹è¿½åŠ ã™ã‚‹

```kotlin
dependencies {
    implementation("io.github.momosetkn:liquibase-kotlin-custom-exposed-migration-change:4.29.2-0.8.0")
}
```

ãã†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§Exposed-migrationã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```kotlin
import momosetkn.liquibase.kotlin.parser.KotlinCompiledDatabaseChangeLog
import momosetkn.liquibase.kotlin.change.custom.exposed.customExposedMigrationChange
import org.jetbrains.exposed.sql.SchemaUtils
import org.jetbrains.exposed.sql.Table
import org.jetbrains.exposed.sql.transactions.transaction

class CompiledDatabaseChangelog1 : KotlinCompiledDatabaseChangeLog({
    changeSet(author = "your_name", id = "20241007-2000-1") {
        // https://jetbrains.github.io/Exposed/table-definition.html#dsl-create-table
        val createdByExposed = object : Table("created_by_exposed") {
            val id = integer("id").autoIncrement()
            val name = varchar("name", 256)
            override val primaryKey = PrimaryKey(id)
        }
        customExposedMigrationChange(
            execute = { db ->
                transaction(db) {
                    SchemaUtils.create(createdByExposed)
                }
            },
            rollback = { db ->
                transaction(db) {
                    SchemaUtils.drop(createdByExposed)
                }
            },
        )
    }
})
```

ã¾ãŸã€kotlin-scriptã®å ´åˆã§ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚`org.jetbrains.exposed.sql.*`ã¨`org.jetbrains.exposed.sql.transactions.transaction`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```kotlin
databaseChangeLog {
    changeSet(author = "your_name", id = "20241007-2000-1") {
        // https://jetbrains.github.io/Exposed/table-definition.html#dsl-create-table
        val createdByExposed = object : Table("created_by_exposed") {
            val id = integer("id").autoIncrement()
            val name = varchar("name", 256)
            override val primaryKey = PrimaryKey(id)
        }
        customExposedMigrationChange(
            execute = { db ->
                transaction(db) {
                    SchemaUtils.create(createdByExposed)
                }
            },
            rollback = { db ->
                transaction(db) {
                    SchemaUtils.drop(createdByExposed)
                }
            },
        )
    }
}
```

## ä»–ã®ORM

ç¾åœ¨ã€ä»–ã®ORMã ã¨jOOQã‚„ktormã®æ‹¡å¼µã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã¾ã™ã€‚

```kotlin
dependencies {
    // jOOQ
    implementation("io.github.momosetkn:liquibase-kotlin-custom-jooq-change:4.29.2-0.8.0")
    // Ktorm
    implementation("io.github.momosetkn:liquibase-kotlin-custom-ktorm-change:4.29.2-0.8.0")
}
```
