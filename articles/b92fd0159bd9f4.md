---
title: "Komapperã§éŠã‚“ã§ã¿ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "komapper", "orm", "db"]
published: true
---

â€»2023-09-02ç¾åœ¨ã§ã®æƒ…å ±ã§ã™ã®ã§ã€æœ€æ–°æƒ…å ±ã¯ã€ [Komapperå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.komapper.org/ja/) ãªã©ã‚’è¦‹ã¦ãã ã•ã„

# ç’°å¢ƒ

```
komapper = 1.12.1
java = 20.0.2-tem
gradle = 8.3
kotlin = 1.9.10
db = h2, mysql:5.7
```

# MySQL5.7ã§ã®å‹•ä½œã—ãªã„ã¨ã“ã‚

MySQL8ã§ã¯ã¡ã‚ƒã‚“ã¨å‹•ä½œã—ã¾ã™ï¼

https://github.com/momosetkn/komapper/blob/edf420c006fb63a3eb6efe1e7a74dbcc3474e5dd/integration-test-jdbc/src/test/kotlin/integration/jdbc/JdbcDeleteWhereTest.kt#L51-L54

ã“ã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã€SQLãŒä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
```sql
delete from employee as t0_
```

ãŒã€MySQL5.7ã§ã¯ã€ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
```log
[42000][1064] You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'as t0_' at line 1
```

## åŸå› 
https://github.com/komapper/komapper/blob/20a2bdc967d054af8c78638d1544e2f59712c211/komapper-core/src/main/kotlin/org/komapper/core/dsl/builder/RelationDeleteStatementBuilder.kt#L26-L30
ã“ã“ã§`dialect.supportsAliasForDeleteStatement()`ã¨ã„ã†ãƒ•ãƒ©ã‚°ãŒtrueã«ãªã£ã¦ã„ã‚‹ã¨ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä»˜ãã®DELETEæ–‡ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã§ã™ã€‚

## è§£æ±ºæ³•
ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’falseã¸overrideã™ã‚‹ã€‚ã“ã‚Œã§ã€`delete from employee`ã¨ã„ã£ãŸã‚¯ã‚¨ãƒªã«ãªã‚Šã¾ã™

```kotlin
import org.komapper.jdbc.JdbcDatabase
import org.komapper.jdbc.JdbcDialect
import org.komapper.jdbc.JdbcDialects
import org.komapper.jdbc.DefaultJdbcDatabaseConfig

object MySQL5Dialect : JdbcDialect by JdbcDialects.get("mysql") {
    override fun supportsAliasForDeleteStatement() = false
}

val db by lazy {
    val config = DefaultJdbcDatabaseConfig(
        dataSource = hikariDatasource,
        dialect = MySQL5Dialect,
    )
    JdbcDatabase(config)
}
```

# è¤‡æ•°ã®dialectã‚’ä½¿ã†å ´åˆã®æ³¨æ„ç‚¹

https://github.com/komapper/komapper/blob/00d719b18bf8891317cb78c4af385b7ab584c773/DESIGN_DOC.md#loosely-coupled-architecture
ã«ã‚ã‚‹ã¨ãŠã‚Šã€ServiceLoaderã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¤‡æ•°ã®dialectã‚’ä½¿ã†å ´åˆã€FatJarã«ã—ãŸéš›ã«å•é¡Œç‚¹ãŒå‡ºã¦ãã¾ã™ã€‚
```kotlin
    val komapperVersion = "1.12.1"
    implementation("org.komapper:komapper-dialect-h2-jdbc:$komapperVersion")
    implementation("org.komapper:komapper-dialect-mysql-jdbc:$komapperVersion")
```

ã‚¨ãƒ©ãƒ¼ã®å†…å®¹
```log
 Caused by: java.lang.IllegalStateException: The dialect is not found for the JDBC url. Try to add the 'komapper-dialect-mysql-jdbc' dependency. driver='mysql'
     at org.komapper.jdbc.JdbcDialects.get(JdbcDialects.kt:24)
```

## åŸå› 

https://github.com/komapper/komapper/blob/bc289886313a85146b1c371d1869710e1115b634/komapper-jdbc/src/main/kotlin/org/komapper/jdbc/JdbcDialects.kt#L20-L25
ã“ã“ã§ã€ServiceLoader#loadã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€FatJarã«ã—ãŸéš›ã«ã€åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ãŒServiceLoader.loadçµŒç”±ã§è¤‡æ•°ã‚ã‚‹ã¨ã€ã†ã¾ããƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„ã‚ˆã†ã§ã™ã€‚

## è§£æ±ºç­–

å‚è€ƒ [Gradle Shadow Pluginã§ä½œæˆã—ãŸfat/uber JARã§ã€è¤‡æ•°ã®JDBCãƒ‰ãƒ©ã‚¤ãƒãŒãƒ­ãƒ¼ãƒ‰ã§ããªã„](https://zenn.dev/onozaty/articles/shadowjar-merge-service-files)

build.gradle.ktsã«ä»¥ä¸‹è¿½åŠ 

```agsl

plugins {
    // ~
    id("com.github.johnrengelman.shadow") version "8.1.1"
}
tasks {
    withType<com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar>() {
        mergeServiceFiles()
    }
}
```

# Komapperã§éŠã‚“ã§ã¿ãŸæ„Ÿæƒ³

## SQLã¨ä¹–é›¢ãŒã‚ã¾ã‚Šç„¡ã„DSLï¼ˆSQLã‚ªã‚¸ã‚µãƒ³ã«ã¨ã£ã¦ã¯å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„ï¼‰

ä¾‹ãˆã°ã€ã“ã†ã„ã†ã®ã¨ã‹â€¦

Exposed
```kotlin
Member.select(Member.id eq id).single()
```
Komapper
```kotlin
val m = Meta.Member
QueryDsl.from(m).where { m.id eq id }.single()
```

Exposedã®selectãƒ¡ã‚½ãƒƒãƒ‰ãŒwhereãªã®ã¯â€¦

## eager loadingçš„ãªæ©Ÿèƒ½ã‚‚ä½¿ã„ã‚„ã™ã„

[SQLAlchemy](https://docs.sqlalchemy.org/en/14/orm/loading_relationships.html#relationship-loading-techniques) ã®joined loadingã¨ä¼¼ãŸæ„Ÿã˜ã§ä½¿ãˆã‚‹ã€‚
joinã—ã¦includeAll()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¹ã°ç´ä»˜ã„ãŸçŠ¶æ…‹ã§è¿”ã£ã¦ãã‚‹

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿ

é–‹ç™ºè€…ãŒSeasar2ã‚„Domaã¨ã„ã£ãŸJavaã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½œã£ã¦ã„ãŸæ—¥æœ¬äººã§ã‚‚ã‚ã‚‹

## SQLã‚’æ›¸ããŸã„å ´åˆã‚‚å¯¾å¿œã—ã¦ã„ã‚‹

Domaã®ä¸Šä½äº’æ›ã¨ã„ã†ä½ç½®ã¥ã‘ï¼Ÿãªã®ã§ã€SQLã‚’æ›¸ããŸã„å ´åˆã‚‚å¯¾å¿œã—ã¦ã„ã‚‹
[TEMPLATEã‚¯ã‚¨ãƒª \| Komapper](https://www.komapper.org/ja/docs/reference/query/querydsl/template/)

[Ktorm \| Dialects and Native SQL](https://www.ktorm.org/en/dialects-and-native-sql.html)
ä¸€æ–¹ã€Ktormã¯ã€SQLã‚’æ›¸ããŸã„å ´åˆã¯ã€jdbcã®java.sql.Connectionã‚’ç›´æ¥ã•ã‚ã‚Œã£ã¦â€¦ã‚‚ã¯ã‚„ã€SQLã‚’æ›¸ããŸã‹ã£ãŸã‚‰ã€ä»–ã®DBã‚¢ã‚¯ã‚»ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨çµ„ã¿åˆã‚ã›ãŸã»ã†ãŒè‰¯ã•ãã†ã€‚

## ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ãŒã¤ã„ã¦ã„ã‚‹

é–‹ç™ºåˆæœŸã«ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã‚ã£ã¦ã€ãã‚Œã‚’ä½¿ã„ãŸã„å ´åˆã¨ã‹ã€è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ãŒã‚ã‚‹ã¨ä¾¿åˆ©

[Gradleãƒ—ãƒ©ã‚°ã‚¤ãƒ³ \| Komapper](https://www.komapper.org/ja/docs/reference/gradle-plugin/)
é–‹ç™ºä¸­ã«ã€è‡ªå‹•ç”Ÿæˆçµæœã¨diffã‚’å–ã£ã¦ã€é€ä¸€åæ˜ ã—ã¦ã„ãã¨ã„ã†ã®ã‚‚è‰¯ã•ãã†ã€‚
â€»@KomapperOneToManyã‚’ã¤ã‘ãŸã‚Šã—ã¦ã€çµå±€ã€è‡ªå‹•ç”Ÿæˆçµæœã¨ä¸€è‡´ã—ãªããªã‚‹ã®ã§ã€è‡ªå‹•ç”Ÿæˆçµæœã‚’ãã®ã¾ã¾ä½¿ã†ã®ã¯é›£ã—ã„ã‹ã‚‚

## Kotlinã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€DSLãŒç°¡æ½”

Kotlinã®infixè¨˜æ³•ãŒä½¿ãˆã‚‹ã®ã§ã€Javaç³»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ˆã†ã«ã‚«ãƒƒã‚³ãŒå¤šããªã‚‰ãªãã¦è‰¯ã„

## å…¨ä½“çš„ã«

ã„ã‚ã„ã‚ä¸åº¦ã„ã„ï¼ˆé›‘ï½—ï¼‰
ã—ã‹ã—ã€ä½¿ç”¨è€…ãŒå°‘ãªã„ã®ã§ã€å•é¡ŒãŒèµ·ããŸã‚‰ã€è‡ªåˆ†ã§ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã™ã‚‹ã‹ã€é–‹ç™ºè€…æœ¬äººã«èãå¿…è¦ãŒã‚ã‚‹ã€‚ãªã®ã§ã€ã‚‚ã£ã¨ã¿ã‚“ãªä½¿ã£ã¦æ¬²ã—ã„â€¦ã€‚
